# トンネル管理アプリケーション 仕様書 v2.0（下書き）

## 1. 概要

### 1.1 目的
ローカル環境で動作する複数のトンネルサービス（ngrok, Cloudflare Tunnelなど）を、Webインターフェースから統合的に管理するアプリケーション。

### 1.2 主要機能
- トンネル定義の自動検出
- トンネルの起動・停止制御
- リアルタイムな状態表示
- 設定の外部化

### 1.3 用語定義
- **トンネル**：ローカルサービスを外部に公開するための転送経路
- **LocalUrl**：トンネルの転送元となるローカルアドレス（例：http://localhost:8080）
- **TunnelUrl**：トンネルによって生成される公開URL
- **Detector**：トンネル定義や稼働中のトンネルを検出する機能
- **Runner**：トンネルの起動・停止を制御する機能

---

## 2. 機能仕様

### 2.1 トンネル検出機能 (Detector)
- アプリケーション起動時および定期的に、設定ファイルやAPIからトンネル定義を検出
- 検出対象：
  - 設定ファイルに定義されたトンネル
  - CLIツールのAPIから取得できる稼働中のトンネル
- 検出されたトンネルは以下のいずれかの状態を持つ：
  - `Running`：Detectorにより稼働が確認された
  - `Stopped`：Detectorにより停止が確認された
  - `Unknown`：定義のみ存在する（未稼働）
- 状態の優先順位：Running > Stopped > Unknown

### 2.2 トンネル操作機能

#### SingleRunner（単一トンネル操作）
- 個別起動：`Stopped` or `Unknown`状態のトンネルを起動
- 個別停止：`Running`状態のトンネルを停止
- 状態取得：トンネルの状態を取得

#### GroupRunner（複数トンネル一括操作）
- 一括起動：複数のトンネルをまとめて起動
- 一括停止：複数のトンネルをまとめて停止
- 一括状態取得：複数トンネルの状態をまとめて取得

いずれもWebインターフェースから実行可能。


### 2.3 マージ処理の種類と流れ

#### 1. TunnelItem同士のマージ
- **目的**：同一トンネル（同一ID）について、異なる情報源から得られたTunnelItem同士を1つに統合する
- **同一性判定**：`TunnelItem#getId()`のロジック（localUrl, tunnelUrl, tunnelProviderの組み合わせ）で一致するもの
- **ルール**：
  - 状態（status）は優先順位（Running > Stopped > Unknown）で代表を決定
  - sources等は全て統合
  - オプション情報（publicUrl等）は優先度の高い方を採用し、なければ補完

#### 2. Detectorごとに検出されたTunnelItemリストのマージ
- **目的**：複数のDetectorから得られたTunnelItemリストを、getId()でグループ化・統合し、重複を排除したdetectorItemsリストを作成する
- **流れ**：
  1. 各DetectorからTunnelItemリストを取得
  2. getId()でグループ化
  3. 同じグループ内のTunnelItemを「TunnelItem同士のマージ」ルールで統合

#### 3. UI表示用リストのマージ
- **目的**：アプリケーションが管理するrunnerItemsリストと、検出のみのdetectorItemsリストを統合し、UIに表示する最終リスト（displayList）を作成する
- **流れ**：
  1. runnerItemsの各TunnelItemをdisplayListに追加（getId()で管理）
  2. まだdisplayListに含まれていないgetId()のdetectorItemsを追加
  3. displayListをUIに提供

---

## 3. データモデル仕様

### 3.1 TunnelItem

| フィールド名      | 型                      | 説明                                               |
|-------------------|-------------------------|----------------------------------------------------|
| localUrl          | LocalUrl                | 転送元ローカルアドレス（例: http://localhost:8080）|
| sources           | Set<DetectorName>       | 検出元Detector名の集合                             |
| status            | TunnelStatus            | トンネルの状態（Running, Stopped, Unknown）        |
| tunnelNames       | Set<TunnelName>         | トンネル名の集合（識別や表示用）                   |
| tunnelProvider    | Optional<TunnelProvider>| プロバイダー名（ngrok, cloudflare等）              |
| tunnelUrl         | Optional<TunnelUrl>     | 公開URL                                            |
| meta              | Map<String, String>     | 任意の追加メタデータ（PID等）                      |

- **不変性**：全フィールドはコンストラクタで完全初期化され、setterは持たない。コレクションは防御的コピーで不変化。
- **同一性判定**：`getId()`のSHA-256ハッシュ値（localUrl, tunnelUrl, tunnelProviderの組み合わせ）で一意。

### 3.2 Value Object群

| 名称           | 説明・責務                                         |
|----------------|----------------------------------------------------|
| LocalUrl       | ローカルアドレス値オブジェクト。正規化・バリデーション責任を持つ |
| TunnelName     | トンネル名値オブジェクト。表示や識別用             |
| TunnelProvider | プロバイダー名値オブジェクト。型安全な管理         |
| TunnelUrl      | 公開URL値オブジェクト。正規化・バリデーション責任を持つ |
| DetectorName   | 検出元名値オブジェクト                             |

### 3.3 TunnelStatus（Enum）

| 値      | 意味                   |
|---------|------------------------|
| Running | 稼働中                 |
| Stopped | 停止が検出された       |
| Unknown | 定義のみ、稼働状況不明 |

- **優先順位**：Running > Stopped > Unknown（`isHigherPriorityThan()`で比較可能）


# 4. コンポーネント設計

## 4.1 全体構成
- プレゼンテーション層: WebServer, WsEventBus
- アプリケーション層: Usecase, DetectionWorker, Registry
- ドメイン層: Runner, Detector,
- インフラストラクチャ層: ConfigParser, TemplateWriter

## 4.2 主要コンポーネント

### WebServer
- 役割：REST API の提供、WebSocket接続の管理
- 主な機能：
  - GET /api/detect/all
  - GET /api/detect/{id}
  - POST /api/group/start/{id}
  - POST /api/group/stop/{id}
  - POST /api/single/start/{id}
  - POST /api/single/stop/{id}
  - WebSocket: /api/detect/all/ws

### WsEventBus<T>
- 役割：WebSocket接続の管理と通知配信
- 主なメソッド：
  - addContext(WsContext)
  - removeContext(WsContext)
  - notify(T)
- 補足
  - 可変クラス

### DetectionWorker
- 役割：定期的なトンネル検出の実行
- 構成：
  - DetectUsecase による検出
  - WsEventBus<List<TunnelItem>> による通知
  - Config による間隔制御

### Usecase
- DetectUsecase
  - CompletableFuture<List<TunnelItem>> detectAll()
  - CompletableFuture<TunnelItem> detect(String id)
- RunTunnelUsecase
  - CompletableFuture<TunnelItem> startSingleTunnel(String id)
  - CompletableFuture<Void> stopSingleTunnel(String id)
  - CompletableFuture<TunnelItem> startGroupTunnel(String id)
  - CompletableFuture<Void> stopGroupTunnel(String id)

### SingleRunner / GroupRunner
- SingleRunner
  - CompletableFuture<TunnelItem> start(TunnelItem request)
  - CompletableFuture<Boolean> stop(String tunnelId)
  - CompletableFuture<TunnelItem> getStatus(String tunnelId)
- GroupRunner
  - CompletableFuture<List<TunnelItem>> start(List<TunnelItem>)
  - CompletableFuture<Boolean> stop(List<String>)
  - CompletableFuture<List<TunnelItem>> getStatus()

### Registry
- 役割：検出されたトンネル情報の保持(detectionList, runningList)
- 主なメソッド：
  - List<TunnelItem> getDisplayList()
  - void putDetecionItems(List<TunnelItem>)
  - void putRunnerItem(TunnelItem)
- 補足
  - 可変クラス